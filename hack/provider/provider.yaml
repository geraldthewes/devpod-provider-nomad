name:  nomad
version: ##VERSION##
description: |-
  DevPod on Nomad
icon: https://url-to-icon.com  # Shown in the Desktop App
options:
  # Options for the provider, DevPod will pass these as
  # ENV Variables when calling the provider
  AGENT_PATH:
    description: The path where to inject the DevPod agent to.
    default: /tmp/devpod-workspaces/devpod
  AGENT_DATA_PATH:
    description: The path where to store the agent data.
    default: /tmp/devpod-workspaces/agent
  NOMAD_NAMESPACE:
    description: The namespace for the Nomad job
    default:
  NOMAD_REGION:
    description: The region for the Nomad job
    default:
  NOMAD_CPU:
    description: The cpu in mhz to use for the Nomad Job
    default: "200"
  NOMAD_MEMORYMB:
    description: The memory in mb to use for the Nomad Job
    default: "512"
  NOMAD_DISKMB:
    description: The ephemeral disk in mb to use for the Nomad Job
    default: "300"
  VAULT_ADDR:
    description: |-
      Vault server address (e.g., https://vault.example.com:8200).
      Required when VAULT_SECRETS_JSON is specified.
    default:
  VAULT_ROLE:
    description: |-
      Vault role for Nomad workload identity authentication.
      Used by Nomad to obtain Vault tokens for the task.
    default: "nomad-workloads"
  VAULT_NAMESPACE:
    description: |-
      Vault namespace (Vault Enterprise only).
      Leave empty if not using Vault Enterprise namespaces.
    default:
  VAULT_CHANGE_MODE:
    description: |-
      Action to take when secrets change (restart, noop, or signal).
      restart: Restart the task when secrets change (default).
      noop: Do nothing when secrets change.
      signal: Send a signal when secrets change.
    default: "restart"
  VAULT_POLICIES_JSON:
    description: |-
      JSON array of Vault policies to attach to the task.
      Example: ["aws-read", "database-read"]
      Required when VAULT_SECRETS_JSON is specified.
    default:
  VAULT_SECRETS_JSON:
    description: |-
      JSON array of Vault secret configurations.
      Each secret specifies a Vault KV v2 path and field-to-env-var mappings.
      Example: [{"path":"secret/data/aws/creds","fields":{"access_key":"AWS_ACCESS_KEY_ID","secret_key":"AWS_SECRET_ACCESS_KEY"}}]
      Secrets are injected as environment variables into the container.
    default:
agent:
  path: ${AGENT_PATH}
  dataPath: ${AGENT_DATA_PATH}
  inactivityTimeout: ${INACTIVITY_TIMEOUT}
  injectGitCredentials: ${INJECT_GIT_CREDENTIALS}
  injectDockerCredentials: ${INJECT_DOCKER_CREDENTIALS}
binaries:  # Optional binaries DevPod should download for this provider
  NOMAD_PROVIDER: # Will be available as NOMAD_PROVIDER environment variable in the exec section
    - os: linux
      arch: amd64
      path: https://github.com/geraldthewes/devpod-provider-nomad/releases/download/##VERSION##/devpod-provider-nomad-linux-amd64
      checksum: ##CHECKSUM_LINUX_AMD64##
    - os: linux
      arch: arm64
      path: https://github.com/geraldthewes/devpod-provider-nomad/releases/download/##VERSION##/devpod-provider-nomad-linux-arm64
      checksum: ##CHECKSUM_LINUX_ARM64##
    - os: darwin
      arch: amd64
      path: https://github.com/geraldthewes/devpod-provider-nomad/releases/download/##VERSION##/devpod-provider-nomad-darwin-amd64
      checksum: ##CHECKSUM_DARWIN_AMD64##
    - os: darwin
      arch: arm64
      path: https://github.com/geraldthewes/devpod-provider-nomad/releases/download/##VERSION##/devpod-provider-nomad-darwin-arm64
      checksum: ##CHECKSUM_DARWIN_ARM64##
    - os: windows
      arch: amd64
      path: https://github.com/geraldthewes/devpod-provider-nomad/releases/download/##VERSION##/devpod-provider-nomad-windows-amd64.exe
      checksum: ##CHECKSUM_WINDOWS_AMD64##
exec:
  command: |-
    DEVCONTAINER_COMMAND="${COMMAND}" DEVCONTAINER_USER="${USER}" ${NOMAD_PROVIDER} command
  create:  ${NOMAD_PROVIDER} create # Optional: a command to create the machine
  delete:  ${NOMAD_PROVIDER} delete # Optional: a command to delete the machine
  status:  ${NOMAD_PROVIDER} status # Optional: a command to get the machine's status
  init:    ${NOMAD_PROVIDER} init # Optional: a command to init the provider, login to an account or similar
